# [script-agent] 개발 로그 #01 - 스크립트 생성 파이프라인 구현

**작성일**: 2025-11-05 14:09
**담당**: Script Gen Pipeline Agent (Claude Code)
**브랜치**: jacti/workflow-02_inforetrieval

---

## 📋 작업 요약

스크립트 작성 파이프라인(Pipeline 2) 구현을 완료했습니다.
정보 검색 파이프라인이 생성한 Markdown 파일을 읽어 오디오 가이드 스크립트를 생성하는 모듈입니다.

**핵심 특징**: 프롬프트 버전 관리 시스템을 파일명 기반으로 단순하게 설계하여 향후 프롬프트 엔지니어링을 쉽게 반복할 수 있도록 구조화했습니다.

---

## ✅ 완료된 작업

### 1. 프롬프트 버전 관리 시스템 설계

**위치**: `prompts/script_generation/`

- 파일명 기반 버전 관리 방식 채택 (v1.yaml, v2.yaml, ...)
- 불필요한 메타데이터 중복 제거 (버전 정보는 파일명으로만 관리)
- YAML 형식으로 프롬프트 템플릿 저장

**생성된 파일**:
- `prompts/script_generation/v1.yaml` - 기본 친절한 톤
- `prompts/script_generation/v2.yaml` - 교육적 톤
- `prompts/script_generation/README.md` - 프롬프트 관리 가이드

**템플릿 구조**:
```yaml
name: "프롬프트 이름"
description: "설명"
tags: [tag1, tag2]
parameters:
  duration_minutes: 1.0
  tone: "friendly"
system_prompt: |
  시스템 프롬프트...
user_prompt_template: |
  유저 프롬프트 템플릿...
  {info_content} 등의 변수 사용 가능
```

### 2. 프롬프트 로더 유틸리티 구현

**위치**: `src/utils/prompt_loader.py`

**주요 기능**:
- `load_prompt(version)`: 지정된 버전의 프롬프트 로드
- `list_prompts()`: 사용 가능한 프롬프트 버전 목록 조회
- `PromptTemplate.format_user_prompt(**kwargs)`: 템플릿 변수 치환

**설계 원칙**:
- 단순성: 파일명만으로 버전 식별
- 재사용성: Python 모듈로 쉽게 임포트 가능
- 독립 실행 가능: `python3 src/utils/prompt_loader.py`로 자체 테스트

### 3. 스크립트 생성 파이프라인 구현

**위치**: `src/pipelines/script_gen.py`

**주요 함수**:
- `run(keyword, *, prompt_version="v1", dry_run=False, ...)`: 메인 파이프라인 실행
- `_generate_dry_run_script(keyword, prompt_version)`: 테스트용 고정 스크립트 생성

**입력/출력 계약**:
- 입력: `outputs/info/{keyword}.md`
- 출력: `outputs/script/{keyword}_script.md`

**파라미터**:
- `keyword`: 유물/장소 키워드
- `prompt_version`: 프롬프트 버전 (기본: "v1")
- `dry_run`: True이면 API 호출 없이 테스트 스크립트 생성
- `temperature`: LLM 온도 (기본: 0.7)
- `model`: OpenAI 모델 (기본: "gpt-4o-mini")

**예외 처리**:
- `FileNotFoundError`: 정보 파일 또는 프롬프트 템플릿 없음
- `ValueError`: API 키 미설정
- `Exception`: LLM 호출 실패 등

### 4. CLI 인터페이스 구현

**사용 예시**:
```bash
# 프롬프트 버전 목록 확인
python3 src/pipelines/script_gen.py --list-prompts

# dry-run 모드로 테스트
python3 src/pipelines/script_gen.py --keyword "청자 상감운학문 매병" --dry-run

# 특정 프롬프트 버전 사용
python3 src/pipelines/script_gen.py --keyword "청자 상감운학문 매병" --prompt-version v2
```

### 5. 의존성 추가

**파일**: `requirements.txt`
- `pyyaml>=6.0.0` 추가 (YAML 파일 파싱용)

---

## 🧪 테스트 결과

### 프롬프트 로더 테스트
✅ `python3 src/utils/prompt_loader.py` 실행 성공
- v1, v2 프롬프트 로드 확인
- 템플릿 변수 치환 정상 작동

### 파이프라인 테스트
✅ `--list-prompts` 옵션: v1, v2 목록 정상 출력
✅ `--dry-run` 모드: 고정 템플릿 스크립트 생성 성공
✅ v1, v2 프롬프트 버전별 테스트 통과

**생성된 테스트 파일**:
- `outputs/script/청자_상감운학문_매병_script.md`
- `outputs/script/테스트유물_script.md`

---

## 📝 설계 결정 사항

### 1. 파일명 기반 버전 관리 선택 이유

**초기 설계**:
- YAML 내부에 `metadata.version` 필드
- `versions.json`으로 버전 메타데이터 관리

**문제점**:
- 파일명, YAML 내부, JSON 파일에 버전 정보 중복
- 불필요한 복잡성

**최종 결정**:
- 파일명만으로 버전 관리 (v1.yaml, v2.yaml)
- 단순하고 직관적
- Git으로 변경 이력 추적 가능

### 2. dry_run 모드 구현

**목적**:
- API 호출 없이 파이프라인 동작 검증
- 비용 절감 (OpenAI API 호출 최소화)
- 개발 중 빠른 반복 테스트

**구현**:
- `--dry-run` 플래그 시 고정 템플릿 스크립트 생성
- 프롬프트 로딩과 파일 I/O는 실제로 수행

### 3. 프롬프트 템플릿 변수 치환

**지원 변수**:
- `{info_content}`: 정보 검색 결과
- `{duration_minutes}`: 목표 오디오 길이

**확장성**:
- `parameters` 섹션에 기본값 정의
- 호출 시 `**kwargs`로 오버라이드 가능
- 새 변수 추가 시 YAML만 수정하면 됨

---

## 🔧 후속 작업 제안

### 단기 (v0.1 범위 내)
- [ ] 실제 정보 파일을 사용한 통합 테스트
- [ ] 생성된 스크립트 품질 검증
- [ ] Pipeline 1, 3과의 통합 테스트

### 중기 (v0.2 이후)
- [ ] 프롬프트 버전 추가:
  - v3: 아동용 (쉽고 재미있는 톤)
  - v4: 감성적 (시적이고 서정적인 톤)
- [ ] 스크립트 후처리:
  - 문장 길이 최적화
  - 문단 구분 자동화
  - 호흡 표시 자동 삽입
- [ ] 메타데이터 추가:
  - 생성 시각, 프롬프트 버전, 모델 정보 등
  - JSON 형식으로 별도 저장

### 장기 개선 사항
- [ ] A/B 테스트 프레임워크:
  - 여러 프롬프트 버전 비교
  - 자동 품질 평가
- [ ] 프롬프트 성능 로깅:
  - 버전별 사용 빈도
  - 사용자 피드백 수집
- [ ] 다국어 프롬프트 지원

---

## 📚 참고 문서

- `docs/plan.md` 2절: Pipeline 2 설계 명세
- `docs/claude-squad.md`: 병렬 개발 구조
- `.claude/CLAUDE.md`: 프로젝트 공통 가이드
- `prompts/script_generation/README.md`: 프롬프트 관리 가이드

---

## 💡 주요 학습 사항

1. **프롬프트 버전 관리는 단순할수록 좋다**
   - 파일명만으로도 충분한 버전 관리 가능
   - Git이 변경 이력을 자동으로 추적

2. **dry_run 모드는 필수**
   - API 비용 절감
   - 빠른 반복 개발 가능

3. **템플릿 변수의 유연성**
   - 파라미터 기본값 + 런타임 오버라이드
   - 프롬프트 수정 없이 동작 변경 가능

---

## 🎯 다음 단계

1. Pipeline 1 (정보 검색) 팀에서 생성한 샘플 파일로 통합 테스트
2. 실제 OpenAI API를 사용한 스크립트 생성 검증
3. 생성된 스크립트를 Pipeline 3 (오디오 생성)에 전달하여 전체 흐름 확인
4. 프롬프트 품질 개선 반복

---

**작업 완료 시각**: 2025-11-05 14:09
**상태**: ✅ 모든 자가 테스트 통과, 코드 리뷰 대기
