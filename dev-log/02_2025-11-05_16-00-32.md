# [script-agent] 개발 로그 #02 - 파이프라인 통합 (path_sanitizer 적용)

**작성일**: 2025-11-05 16:00
**담당**: Script Gen Pipeline Agent (Claude Code)
**브랜치**: jacti/workflow-02_inforetrieval

---

## 📋 작업 요약

`docs/commands/pipeline-integration.md`의 지시에 따라 스크립트 생성 파이프라인을 공통 경로 관리 시스템에 통합했습니다. 기존의 개별 파일명 생성 로직을 제거하고 `src/utils/path_sanitizer.py`의 헬퍼 함수를 사용하도록 리팩토링했습니다.

**핵심 변경**: 파일명 규칙을 Pipeline 1~3이 모두 동일하게 사용하도록 통일 (공백 유지, 특수문자만 제거)

---

## ✅ 완료된 작업

### 1. `src/pipelines/script_gen.py` 수정

**추가된 import**:
```python
from src.utils.path_sanitizer import info_markdown_path, script_markdown_path
```

**제거된 로직**:
```python
# 기존 (공백을 언더스코어로 변환)
slug = keyword.replace(" ", "_")
info_file = info_dir / f"{slug}.md"
output_file = output_dir / f"{slug}_script.md"
```

**새로운 로직**:
```python
# 신규 (path_sanitizer 헬퍼 사용)
info_file = info_markdown_path(keyword, info_dir)
output_file = script_markdown_path(keyword, output_dir)
```

### 2. 테스트 수행

#### 테스트 1: dry-run 모드 (기본 키워드)
```bash
python3 src/pipelines/script_gen.py --keyword "청자 상감운학문 매병" --dry-run
```
**결과**: ✅ 성공
- 출력 파일: `outputs/script/청자 상감운학문 매병_script.md` (공백 유지)
- 기존: `outputs/script/청자_상감운학문_매병_script.md` (언더스코어)

#### 테스트 2: list-prompts 기능
```bash
python3 src/pipelines/script_gen.py --list-prompts
```
**결과**: ✅ 정상 작동
- v1, v2 프롬프트 목록 출력 확인

#### 테스트 3: 특수문자 제거 규칙 검증
```bash
python3 src/pipelines/script_gen.py --keyword "백자 청화 \"산수문\" 항아리" --dry-run
```
**결과**: ✅ 성공
- 입력: `백자 청화 "산수문" 항아리`
- 출력: `outputs/script/백자 청화 산수문 항아리_script.md`
- 특수문자(`"`) 제거, 공백 유지 확인

---

## 📝 변경 사항 요약

### 파일명 규칙 변경

| 항목 | 기존 규칙 | 신규 규칙 |
|------|-----------|-----------|
| 공백 처리 | `_` (언더스코어로 변환) | 공백 유지 |
| 특수문자 | 미정의 | `<>:"/\|?*` 제거 |
| 예시 | `청자_상감운학문_매병.md` | `청자 상감운학문 매병.md` |

### 코드 라인 수 변경
- **제거**: 2줄 (slug 생성 로직)
- **추가**: 1줄 (import)
- **수정**: 2줄 (경로 생성)
- **순 변경**: -1줄 (코드 간소화)

---

## 🔄 통합 효과

### 1. 파이프라인 간 일관성 확보
- Pipeline 1 (정보 검색): `outputs/info/{keyword}.md`
- Pipeline 2 (스크립트 생성): `outputs/script/{keyword}_script.md`
- Pipeline 3 (오디오 생성): `outputs/audio/{keyword}.mp3`

모두 동일한 `sanitize_keyword_for_path` 규칙 사용

### 2. 유지보수성 향상
- 파일명 규칙 변경 시 `path_sanitizer.py`만 수정하면 됨
- 각 파이프라인에서 중복 로직 제거

### 3. 테스트 용이성
- 공통 헬퍼 함수 단위 테스트 가능
- 특수문자 처리 로직이 한 곳에 집중

---

## ⚠️ 영향 범위 분석

### 1. 기존 파일과의 호환성
**문제**: 기존에 언더스코어 형식으로 생성된 파일들과 새 형식이 다름
- 예: `청자_상감운학문_매병_script.md` vs `청자 상감운학문 매병_script.md`

**영향**:
- 기존 테스트 파일들은 새 규칙으로 재생성 필요
- 실제 프로덕션 환경에서는 migration 전략 필요

**해결 방안**:
- v0.1 MVP 단계에서는 테스트 데이터만 존재하므로 재생성으로 해결
- 향후 프로덕션 배포 시 파일명 migration 스크립트 필요

### 2. 운영체제별 파일명 제한
**검증 완료**:
- macOS: 공백 포함 파일명 생성 ✅
- `path_sanitizer.py`의 `_INVALID_FILENAME_CHARS`가 주요 OS 호환

**참고**: Windows, Linux에서도 공백 파일명 지원하지만 셸 명령어에서 따옴표 필요

### 3. 프롬프트 로딩 로직
**영향 없음**: ✅
- 프롬프트 템플릿 로딩은 경로 변경과 독립적
- v1, v2 프롬프트 정상 작동 확인

---

## 🧪 향후 통합 테스트 계획

### 단기 (이번 스프린트)
1. **Pipeline 1과의 통합 테스트**
   - 정보 검색 파이프라인이 생성한 실제 파일로 스크립트 생성 테스트
   - 파일명 일치 여부 검증

2. **Pipeline 3과의 통합 테스트**
   - 생성된 스크립트를 오디오 파이프라인에 전달
   - 전체 파이프라인 실행 검증

### 중기 (v0.2)
1. **End-to-End 테스트 자동화**
   - 키워드 입력 → 정보 검색 → 스크립트 → 오디오 전체 흐름
   - 다양한 키워드 케이스 (공백, 특수문자, 긴 이름 등)

2. **성능 테스트**
   - 대량 배치 처리 시나리오
   - 파일 I/O 최적화

---

## 🎯 다음 단계

### 즉시
- [x] path_sanitizer 적용 완료
- [ ] Pipeline 1, 3 팀과 통합 테스트 일정 조율
- [ ] 기존 테스트 파일 정리 (언더스코어 → 공백 형식)

### 대기 중
- [ ] python-pipeline-architect 기준 리팩토링 (별도 작업)
  - 설정 클래스 (ScriptGenConfig)
  - 커스텀 예외
  - 재시도 로직
  - pytest 테스트 스위트

---

## 📚 참고 문서

- `docs/commands/pipeline-integration.md`: 통합 작업 명세
- `src/utils/path_sanitizer.py`: 공통 경로 헬퍼
- `dev-log/01_2025-11-05_14-09-22.md`: 초기 파이프라인 구현

---

## 💡 주요 학습 사항

1. **공통 유틸리티의 중요성**
   - 중복 로직 제거로 버그 감소
   - 단일 수정 지점으로 유지보수 간소화

2. **파일명 규칙 통일의 필요성**
   - 파이프라인 간 데이터 흐름에서 파일명 일치 필수
   - 공백 vs 언더스코어 같은 사소한 차이가 통합 오류 유발

3. **점진적 리팩토링 전략**
   - 먼저 통합 작업 완료 → 이후 architecture 개선
   - 단계별 검증으로 리스크 최소화

---

**작업 완료 시각**: 2025-11-05 16:00
**상태**: ✅ path_sanitizer 통합 완료, 모든 테스트 통과
**후속 작업**: Pipeline 1, 3과의 통합 테스트 대기
